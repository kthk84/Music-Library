<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 Cleaner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=6">
</head>
<body>
    <!-- Action progress bar: fixed at viewport top, only visible on Sync tab when there is progress/queue (outside .container so position:fixed is viewport-relative) -->
    <div id="shazamBatchJobsSection" class="shazam-batch-jobs-section" style="display:none;">
        <div id="shazamSyncProgress" class="shazam-sync-progress-bar" style="display:none;" role="button" tabindex="0" onclick="shazamScrollToCurrentTrack(event)" onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); shazamScrollToCurrentTrack(); }">
            <span class="shazam-running-label">Running:</span>
            <span id="shazamProgress" class="shazam-progress-text"></span>
            <button type="button" id="shazamProgressGotoBtn" class="btn btn-small btn-secondary shazam-progress-goto-btn" style="display:none;" onclick="event.stopPropagation(); shazamScrollToCurrentTrack();">Follow row</button>
            <button type="button" id="shazamDownloadViewLogBtn" class="btn btn-small btn-secondary" style="display:none;" onclick="event.stopPropagation(); shazamShowDownloadLog();" title="View last lines of soundeo_download.log">View log</button>
            <button type="button" id="shazamSyncStopBtn" onclick="shazamStopSync()" class="btn btn-small btn-danger">Stop</button>
        </div>
        <div id="shazamSingleSearchQueueBar" class="shazam-single-search-queue-bar" style="display:none;">
            <span id="shazamSingleQueueBarLabel" class="shazam-job-queue-label">Search queue:</span>
            <div id="shazamSingleSearchQueueList" class="shazam-job-queue-list"></div>
        </div>
        <div id="shazamStarQueueBar" class="shazam-single-search-queue-bar" style="display:none;">
            <span class="shazam-job-queue-label">Star queue:</span>
            <div id="shazamStarQueueList" class="shazam-job-queue-list"></div>
        </div>
        <div id="shazamUnstarQueueBar" class="shazam-single-search-queue-bar" style="display:none;">
            <span class="shazam-job-queue-label">Unstar queue:</span>
            <div id="shazamUnstarQueueList" class="shazam-job-queue-list"></div>
        </div>
        <div id="shazamDownloadQueueBar" class="shazam-single-search-queue-bar" style="display:none;">
            <span class="shazam-job-queue-label">Download queue:</span>
            <div id="shazamDownloadQueueList" class="shazam-job-queue-list"></div>
        </div>
        <div id="shazamJobQueueBar" class="shazam-job-queue-bar" style="display:none;">
            <span class="shazam-job-queue-label">Queued:</span>
            <div id="shazamJobQueueList" class="shazam-job-queue-list"></div>
            <button type="button" id="shazamJobQueueClearBtn" class="btn btn-small btn-secondary" onclick="shazamClearJobQueue()" title="Clear all queued jobs">Clear queue</button>
        </div>
    </div>

    <!-- Icon definitions (hidden) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;">
        <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></symbol>
        <symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></symbol>
        <symbol id="icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></symbol>
        <symbol id="icon-clean" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><line x1="8" y1="6" x2="8" y2="4"/><line x1="16" y1="6" x2="16" y2="4"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
        <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></symbol>
    </svg>

    <div class="container">
        <div id="connectionBanner" class="connection-banner" style="display:none;" role="alert">
            <strong>Not connected to server.</strong> Open this app at <a href="http://127.0.0.1:5002" target="_blank" rel="noopener">http://127.0.0.1:5002</a> and ensure the server is running (<code>python3 app.py</code>). Buttons and tracks will not work until connected.
        </div>
        <header>
            <h1>MP3 Cleaner</h1>
            <nav class="tab-nav" role="tablist" aria-label="Main sections">
                <button type="button" id="tab-btn-mp3" class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-panel-mp3" data-tab="mp3">Tags</button>
                <button type="button" id="tab-btn-shazam" class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-panel-shazam" data-tab="shazam">Sync</button>
            </nav>
        </header>

        <!-- Tab: MP3 Tags (clean & organize) -->
        <div id="tab-panel-mp3" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-mp3">
        <!-- Step 1: Folder selection -->
        <section id="step1" class="step active">
            <h2>Select folder</h2>
            <div class="folder-input">
                <input type="text" id="folderPath" placeholder="Path will appear here or paste manually" />
                <div class="btn-group">
                    <button type="button" onclick="browseFolder()" class="btn btn-primary">
                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-folder"/></svg>
                        Browse
                    </button>
                    <button type="button" onclick="scanFolder()" class="btn btn-primary">
                        <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-search"/></svg>
                        Scan
                    </button>
                </div>
            </div>
            <div class="path-examples">
                <p class="example-hint">Examples: Mac <code>/Users/you/Music</code> · Windows <code>C:\Users\You\Music</code></p>
            </div>
        </section>

        <!-- Step 2: File list and cleanup -->
        <section id="step2" class="step">
            <h2>Review &amp; clean tags</h2>
            <div class="stats">
                <div class="stat-item"><span class="stat-label">Total</span><span id="totalFiles" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">Processed</span><span id="processedFiles" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">Success</span><span id="successFiles" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">Avg match</span><span id="avgConfidence" class="stat-value">—</span></div>
            </div>

            <div id="filenameAlert" class="filename-alert" style="display: none;">
                <span class="alert-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-warning"/></svg></span>
                <div class="alert-content">
                    <strong>Track numbers in filenames</strong>
                    <p>Remove number prefixes (e.g. "01. Song.mp3" → "Song.mp3").</p>
                </div>
                <button type="button" onclick="cleanAllFilenames()" class="btn btn-warning btn-small">Clean filenames</button>
            </div>

            <div id="spamAlert" class="filename-alert" style="display: none;">
                <span class="alert-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-clean"/></svg></span>
                <div class="alert-content">
                    <strong>Spam in metadata</strong>
                    <p>Comments, URLs or publisher junk can be removed.</p>
                </div>
                <button type="button" onclick="cleanSpamMetadata()" class="btn btn-warning btn-small">Clean spam</button>
            </div>

            <div class="actions">
                <div class="btn-group">
                    <button type="button" onclick="lookupAll()" class="btn btn-primary">Lookup all</button>
                    <button type="button" onclick="saveAll()" class="btn btn-success">Save all</button>
                    <button type="button" onclick="reset()" class="btn btn-secondary">Reset</button>
                </div>
            </div>

            <div id="fileList" class="file-list"></div>
        </section>
        </div>

        <!-- Loading overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p id="loadingText">Processing…</p>
        </div>

        <!-- Tab: Sync -->
        <div id="tab-panel-shazam" class="tab-panel active" role="tabpanel" aria-labelledby="tab-btn-shazam">
        <section id="shazamSync" class="step active shazam-sync-section">

            <details class="settings-panel">
                <summary>Settings <span id="soundeoSessionStatus" class="session-status">not connected</span></summary>
                <div class="settings-body">
                    <div class="folder-list-row">
                        <label>Destination folders</label>
                        <div id="shazamFolderList" class="folder-list"></div>
                        <button type="button" onclick="shazamAddFolder()" class="btn btn-secondary btn-small">Add folder</button>
                    </div>
                    <div class="folder-list-row" id="shazamDownloadFolderRow">
                        <label>Soundeo download folder</label>
                        <div id="shazamDownloadFolderList" class="folder-list"></div>
                        <span class="folder-hint">One folder where AIFF downloads are saved. Must be a destination folder above.</span>
                    </div>
                    <div class="soundeo-session-row">
                        <button type="button" id="shazamSaveSessionBtn" onclick="shazamSaveSession()" class="btn btn-secondary btn-small">Connect Soundeo</button>
                        <button type="button" id="shazamLoggedInBtn" onclick="shazamSessionSaved()" class="btn btn-small" style="display:none;background:var(--accent);color:white;">I have logged in</button>
                        <button type="button" onclick="shazamCheckBrowser()" class="btn btn-small" title="Diagnose why browser may not open">Check browser</button>
                    </div>
                    <p id="soundeoSessionPath" class="folder-hint" style="display:none;"></p>
                    <p id="configPathHint" class="folder-hint config-path-hint" style="display:none;"></p>
                </div>
            </details>

            <div id="shazamCompareProgress" class="shazam-compare-progress" style="display:none;">
                <div class="shazam-compare-progress-bar"><div id="shazamCompareProgressFill" class="shazam-compare-progress-fill"></div></div>
                <span id="shazamCompareProgressText" class="shazam-compare-progress-text">Scanning…</span>
                <button type="button" onclick="shazamCancelCompare()" class="btn btn-small btn-danger">Stop</button>
            </div>

            <div class="toolbar">
                <div class="toolbar-group">
                    <button type="button" onclick="shazamFetchShazam()" class="btn btn-shazam" id="shazamFetchBtn"><span class="shazam-btn-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></span>Shazam</button>
                    <div class="search-dropdown-wrap toolbar-group">
                        <button type="button" id="shazamSearchDropdownBtn" class="btn btn-secondary" title="Search: unfound (orange) or new (grey) tracks" aria-haspopup="true" aria-expanded="false">
                            Search <span class="search-dropdown-chevron" aria-hidden="true">▾</span>
                        </button>
                        <div class="search-dropdown-menu" id="shazamSearchDropdownMenu" role="menu">
                            <button type="button" class="search-dropdown-item" role="menuitem" data-mode="new"><span class="status-dot status-no-link" aria-hidden="true"></span> Search New Shazam Entries on Soundeo</button>
                            <button type="button" class="search-dropdown-item" role="menuitem" data-mode="unfound"><span class="status-dot status-not-found" aria-hidden="true"></span> Search Unfound Shazam Entries on Soundeo</button>
                        </div>
                    </div>
                </div>
                <div class="toolbar-divider"></div>
                <div class="favorites-dropdown-wrap toolbar-group">
                    <button type="button" id="shazamFavoritesDropdownBtn" class="btn btn-small btn-secondary" title="Sync starred state from Soundeo" aria-haspopup="true" aria-expanded="false">
                        Sync starred <span class="search-dropdown-chevron" aria-hidden="true">▾</span>
                    </button>
                    <div class="search-dropdown-menu" id="shazamFavoritesDropdownMenu" role="menu">
                        <button type="button" class="search-dropdown-item" role="menuitem" data-scan-range="all">All</button>
                        <button type="button" class="search-dropdown-item" role="menuitem" data-scan-range="1_month">Last month</button>
                        <button type="button" class="search-dropdown-item" role="menuitem" data-scan-range="2_months">2 months</button>
                        <button type="button" class="search-dropdown-item" role="menuitem" data-scan-range="3_months">Last quarter</button>
                    </div>
                </div>
                <div class="toolbar-divider"></div>
                <div class="rescan-dropdown-wrap toolbar-group">
                    <button type="button" id="shazamRescanDropdownBtn" class="btn btn-secondary btn-small" title="Rescan local folders" aria-haspopup="true" aria-expanded="false">
                        Rescan <span class="search-dropdown-chevron" aria-hidden="true">▾</span>
                    </button>
                    <div class="search-dropdown-menu" id="shazamRescanDropdownMenu" role="menu">
                        <button type="button" class="search-dropdown-item" role="menuitem" data-rescan-mode="compare">Rescan local and match</button>
                        <button type="button" class="search-dropdown-item" role="menuitem" data-rescan-mode="only">Rescan local only</button>
                        <button type="button" class="search-dropdown-item" role="menuitem" data-rescan-mode="match_only">Match only</button>
                    </div>
                </div>
                <div class="toolbar-stats">
                    <span id="shazamCount">0</span> shazam · <span id="shazamLocalCount">0</span> local · <span id="shazamHaveCount">0</span> have · <span id="shazamToDownloadCount">0</span> to DL
                </div>
            </div>

            <div id="shazamFolderWarning" class="shazam-folder-warning" style="display:none;"></div>

            <div class="filters-bar">
                <div class="filter-group shazam-search-filter-wrap">
                    <span class="shazam-track-search-inner">
                        <input type="text" id="shazamTrackSearch" class="shazam-track-search-input" placeholder="Filter by artist or title…" aria-label="Filter tracks by artist or title" />
                        <button type="button" id="shazamTrackSearchClear" class="shazam-track-search-clear" aria-label="Clear search" title="Clear search" style="display: none;">×</button>
                    </span>
                </div>
                <div class="filter-group">
                    <button type="button" class="btn btn-small shazam-filter-btn active" data-status="all">All</button>
                    <button type="button" class="btn btn-small shazam-filter-btn" data-status="have">Have</button>
                    <button type="button" class="btn btn-small shazam-filter-btn" data-status="todl">To DL</button>
                    <button type="button" class="btn btn-small shazam-filter-btn" data-status="skipped">Skipped</button>
                    <button type="button" class="btn btn-small shazam-filter-btn" data-status="ignored">Ignored</button>
                </div>
                <div class="filter-group">
                    <button type="button" class="btn btn-small shazam-filter-time-btn active" data-time-range="all">All</button>
                    <button type="button" class="btn btn-small shazam-filter-time-btn" data-time-range="1_month">Last month</button>
                    <button type="button" class="btn btn-small shazam-filter-time-btn" data-time-range="3_months">Last quarter</button>
                </div>
            </div>

            <div id="shazamSelectionBar" class="selection-actions-row selection-actions" style="display:none;">
                <span id="shazamSelectedCount">0 selected</span>
                <button type="button" onclick="shazamDownloadSelected()" class="btn btn-secondary btn-small" title="Download AIFF for selected tracks (must have Soundeo link)">Download</button>
                <button type="button" onclick="shazamSkipSelected()" class="btn btn-secondary btn-small">Skip</button>
                <button type="button" onclick="shazamStarSelected()" class="btn btn-primary btn-small btn-has-icon" title="Star selected tracks on Soundeo (tracks must have a link)"><span class="shazam-btn-icon" aria-hidden="true">★</span>Star</button>
            </div>

            <div id="shazamTrackList" class="shazam-track-list"></div>

        </section>
        </div>

        <!-- Result picker modal -->
        <div id="resultPickerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Choose metadata</h3>
                    <button type="button" class="modal-close" onclick="closeResultPicker()" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" onclick="closeResultPicker()" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shazam / Sync playback bar (fixed bottom, shown when playing) -->
    <div id="shazamPlayerBar" class="shazam-player-bar" style="display: none;" role="region" aria-label="Now playing">
        <button type="button" id="shazamBarPlayPause" class="shazam-bar-play-pause" title="Play / Pause" aria-label="Play / Pause" onclick="shazamPlayerBarPlayPause()"><svg viewBox="0 0 24 24" fill="currentColor"><use href="#icon-play"/></svg></button>
        <div class="shazam-bar-track-info">
            <span id="shazamBarTrackLabel" class="shazam-bar-track-label">—</span>
        </div>
        <div class="shazam-bar-scrub-wrap">
            <span id="shazamBarTime" class="shazam-bar-time">0:00</span>
            <div id="shazamBarScrub" class="shazam-bar-scrub" role="slider" aria-label="Seek" tabindex="0" onclick="shazamPlayerBarScrub(event)">
                <div id="shazamBarProgress" class="shazam-bar-progress"></div>
            </div>
            <span id="shazamBarDuration" class="shazam-bar-time">0:00</span>
        </div>
        <button type="button" id="shazamBarClose" class="shazam-bar-close" title="Stop and close" aria-label="Stop and close" onclick="shazamPlayerBarClose()">×</button>
    </div>

    <!-- Context menu for play button (Open file location / Open on Soundeo) -->
    <div id="shazamPlayContextMenu" class="shazam-play-context-menu" role="menu" style="display:none;"></div>

    <script src="{{ url_for('static', filename='app.js') }}?v=12"></script>
<script>
(function() {
    if (typeof switchTab !== 'function' || typeof shazamBootstrapLoad !== 'function') {
        var el = document.getElementById('connectionBanner');
        if (el) {
            el.innerHTML = '<strong>JavaScript failed to load or run.</strong> Open this app at <a href="http://127.0.0.1:5002">http://127.0.0.1:5002</a>, ensure the server is running (<code>python3 app.py</code>), and do a hard refresh (Ctrl+Shift+R / Cmd+Shift+R).';
            el.style.display = 'block';
        }
    }
})();
</script>
</body>
</html>
